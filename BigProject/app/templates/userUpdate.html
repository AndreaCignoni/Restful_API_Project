<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <title>Update User Profile</title>
</head>
<body>
    <form id="userUpdateForm">
        First Name<br><input type="text" id="fname" name="fname" autocomplete="given-name" required><br>
        Last Name<br><input type="text" id="lname" name="lname" autocomplete="family-name" required><br>
        Gender<br>
        male<input type="radio" id="male" name="gender" value="male">
        female<input type="radio" id="female" name="gender" value="female"><br>
        Nationality<br><input type="text" id="nationality" name="nationality" autocomplete="country" required><br>
        Email<br><input type="email" id="email" name="email" autocomplete="email" required><br>
        Username<br><input type="text" id="username" name="username" autocomplete="username" required><br>
        Password<br><input type="password" id="password" name="password" autocomplete="new-password" required><br>
        <span><button id="doUpdateButton" onclick="doUpdate()">Submit</button></span>
    </form>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function showViewAll(){
            document.getElementById('userTable').style.display="block"
            document.getElementById('createUpdateForm').style.display="none"
        }
        function showUpdate(buttonElement){
            document.getElementById('userTable').style.display="none"
            document.getElementById('createUpdateForm').style.display="block"

            document.getElementById('updateLabel').style.display="inline"

            document.getElementById('doUpdateButton').style.display="block"

            var rowElement = buttonElement.parentNode.parentNode;
            var user = getUserFromRow(rowElement);
            populateFormWithUser(user);
        }

        function doUpdate(){
            var user = getUserFromForm();
            var rowElement = document.getElementById(user.id);
            updateUserAjax(user);
            setUserInRow(rowElement, user)
            clearForm();
            showViewAll();
        }

        function addUserToTable(user) {
            var tableElement = document.getElementById('userTable');
            var rowElement = tableElement.insertRow(-1);
            rowElement.setAttribute('id', user.id);

            var cell1 = rowElement.insertCell(0);
            cell1.innerHTML = user.id;

            var cell2 = rowElement.insertCell(1);
            cell2.innerHTML = user.fname;

            var cell3 = rowElement.insertCell(2);
            cell3.innerHTML = user.lname;

            var cell4 = rowElement.insertCell(3);
            cell4.innerHTML = user.gender;

            var cell5 = rowElement.insertCell(4);
            cell5.innerHTML = user.nationality;

            var cell6 = rowElement.insertCell(5);
            cell6.innerHTML = user.email;

            var cell7 = rowElement.insertCell(6);
            cell7.innerHTML = user.username;

            var cell8 = rowElement.insertCell(7);
            cell8.innerHTML = user.password;

            var cell9 = rowElement.insertCell(8);
            cell9.innerHTML = '<button onclick="showUpdate(this)">Update</button>';
        }



        function clearForm(){
            var form = document.getElementById('userUpdateForm');
            form.reset();
        }

        function getUserFromForm(){
            var form = document.getElementById('userUpdateForm');
            var user = {
                id: form.querySelector('input[name="id"]').value,
                fname: form.querySelector('input[name="fname"]').value,
                lname: form.querySelector('input[name="lname"]').value,
                gender: form.querySelector('input[name="gender"]:checked').value,
                nationality: form.querySelector('input[name="nationality"]').value,
                email: form.querySelector('input[name="email"]').value,
                username: form.querySelector('input[name="username"]').value,
                password: form.querySelector('input[name="password"]').value
            };
            return user;
        }

        function populateFormWithUser(user){
            var form = document.getElementById('userUpdateForm');
            form.querySelector('input[name="id"]').disabled = true;

            form.querySelector('input[name="id"]').value  = user.id;
            form.querySelector('input[name="fname"]').value= user.fname;
            form.querySelector('input[name="lname"]').value= user.lname;
            form.querySelector('input[name="gender"][value="' + user.gender + '"]').checked = true;
            form.querySelector('input[name="nationality"]').value= user.nationality;
            form.querySelector('input[name="email"]').value= user.email;
            form.querySelector('input[name="username"]').value= user.username;
            form.querySelector('input[name="password"]').value= user.password;
            return user;
        }

            function updateUserAjax(user){
        console.log("Updating user:", JSON.stringify(user));
        $.ajax({
            url: "/users/" + encodeURI(user.id) + '/profile/update',
            method: "PUT",
            data: JSON.stringify(user),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function(result){
                console.log("Update successful:", result);
            },
            error: function(xhr, status, error){
                console.error("Update error:", status, error);
            }
        });
    }
    </script>
</body>
</html>